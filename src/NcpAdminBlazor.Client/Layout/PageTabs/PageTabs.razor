@using NcpAdminBlazor.Client.Providers
@using NcpAdminBlazor.Client.Models
@implements IDisposable
@inject NavigationManager NavigationManager
@inject MenuProvider MenuProvider

@namespace NcpAdminBlazor.Client.Layout

<div class="pl-2 page-tabs-container border-b app-border-default">
    <MudStack Row Spacing="1">
        @foreach (var item in _pageTabs)
        {
            <MudButton
                Variant="Variant.Text"
                Color="@(_activeRoute == item.Route ? Color.Primary : Color.Default)"
                OnClick="@(() => OnClicked(item))"
                Ripple="false">
                @item.Title
                @if (item.IsCloseable)
                {
                    <MudIconButton
                        OnClick="@(() => OnClosed(item))"
                        Icon="@Icons.Material.Filled.Close"
                        Class="extra-small-icon-button"/>
                }
            </MudButton>
        }
    </MudStack>
</div>

@code {

    /// <summary>
    /// 定义一个公共事件，当标签页关闭时触发。
    /// 其他持有本组件引用的组件可以订阅此事件。
    /// </summary>
    public event Action<string>? OnTabClosed;

    private readonly List<PageTabItem> _pageTabs = [];

    private string? _activeRoute;


    protected override void OnInitialized()
    {
        NavigationManager.LocationChanged += OnLocationChanged;
        HandleLocationChange(NavigationManager.Uri);
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        HandleLocationChange(e.Location);
        InvokeAsync(StateHasChanged);
    }

    private string GetCurrentRoute(string location)
    {
        return $"/{NavigationManager.ToBaseRelativePath(location)}";
    }

    private void HandleLocationChange(string newLocation)
    {
        var currentRoute = GetCurrentRoute(newLocation);
        _activeRoute = currentRoute;

        if (_pageTabs.Any(c => c.Route == currentRoute)) return;
        var menuItem = FindMenuItemByHref(MenuProvider.MenuItems, currentRoute);
        var title = menuItem?.Title ?? GenerateFallbackTitle(currentRoute);
        _pageTabs.Add(new PageTabItem { Route = currentRoute, Title = title, IsCloseable = currentRoute != "/" });
    }

    private void OnClicked(PageTabItem page)
    {
        if (_activeRoute != page.Route)
        {
            NavigationManager.NavigateTo(page.Route);
        }
    }

    private void OnClosed(PageTabItem pageTabItem)
    {
        _pageTabs.Remove(pageTabItem);

        if (_activeRoute == pageTabItem.Route && _pageTabs.Any())
        {
            NavigationManager.NavigateTo(_pageTabs.Last().Route);
        }

        OnTabClosed?.Invoke(pageTabItem.Route);
    }

    // 从 MenuProvider 查找菜单项的核心逻辑
    private static MenuItem? FindMenuItemByHref(IEnumerable<MenuItem> items, string href)
    {
        MenuItem? bestMatch = null;
        foreach (var item in items)
        {
            if (item.Href != null && href.StartsWith(item.Href, StringComparison.OrdinalIgnoreCase) &&
                (bestMatch == null || item.Href.Length > bestMatch.Href!.Length))
            {
                bestMatch = item;
            }

            if (item.ChildItems is null || item.ChildItems.Count == 0) continue;
            var childMatch = FindMenuItemByHref(item.ChildItems, href);
            if (childMatch != null && (bestMatch == null || childMatch.Href!.Length > bestMatch.Href!.Length))
            {
                bestMatch = childMatch;
            }
        }

        return bestMatch;
    }

    // 当无法从菜单中找到标题时的备用方法
    private static string GenerateFallbackTitle(string route)
    {
        var lastSegment = route.Split('/').LastOrDefault(s => !string.IsNullOrEmpty(s));
        // 将 "PageName" 转换为 "Page Name"
        return System.Text.RegularExpressions.Regex.Replace(lastSegment ?? "Page", "([A-Z])", " $1").Trim();
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }

    // 数据模型 (建议将其移至一个共享的 Models 文件夹)
    private class PageTabItem
    {
        public required string Route { get; init; }
        public required string Title { get; init; }
        public bool IsCloseable { get; init; } = true;
    }

}