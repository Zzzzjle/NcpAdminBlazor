@* Acts as a reusable container for search criteria with consistent spacing, default
    input styling, and optional expand/collapse behaviour for additional filters. *@

@using System.Linq
@namespace NcpAdminBlazor.Client.Component

<CascadingValue Value="this" IsFixed="true">
    @if (ChildContent is not null)
    {
        @ChildContent(_itemAttributes)
    }
</CascadingValue>

<MudPaper Outlined Class="p-4">
    <MudForm>
        <MudGrid Spacing="4">
            @foreach (var item in VisibleItems)
            {
                <MudItem xs="12" sm="6" md="4" xl="3">
                    <MudGrid Spacing="2" Class="items-center">
                        <MudItem xs="3" Class="font-medium justify-items-end">
                            <MudText Typo="Typo.body2" Class="font-medium">@(item.Label + ":")</MudText>
                        </MudItem>
                        <MudItem xs="9">
                            @item.ChildContent
                        </MudItem>
                    </MudGrid>
                </MudItem>
            }
            <MudItem xs="12" sm="6" md="4" xl="3" Class="flex ml-auto">
                <MudStack Row="true" Class="w-full" Spacing="4" AlignItems="AlignItems.Center"
                          Justify="Justify.FlexEnd">
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Inherit"
                               Disabled="_loading"
                               OnClick="@HandleResetAsync">
                        重置
                    </MudButton>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               Disabled="_loading"
                               OnClick="@HandleSearchAsync">
                        @if (_loading)
                        {
                            <MudProgressCircular Indeterminate="true" Class="me-1" Size="Size.Small"/>
                        }
                        搜索
                    </MudButton>
                    @if (ShouldShowMoreButton)
                    {
                        <MudButton Variant="Variant.Text"
                                   Color="Color.Info"
                                   StartIcon="@(_showAll ? Icons.Material.Filled.KeyboardArrowUp : Icons.Material.Filled.KeyboardArrowDown)"
                                   OnClick="@ToggleShowAll">
                            @(_showAll ? "收起" : "更多")
                        </MudButton>
                    }
                </MudStack>
            </MudItem>
        </MudGrid>
    </MudForm>
</MudPaper>

@code {

    // Items registered by individual QueryFormItem components.
    private readonly List<QueryFormItem> _items = [];

    // Tracks whether all search fields should currently be visible.
    private bool _showAll;

    // Indicates an ongoing search request to disable actions and show progress.
    private bool _loading;

    /// <summary>
    /// Margin applied to input fields unless consumers override it via additional attributes.
    /// </summary>
    [Parameter]
    public Margin ItemMargin { get; set; } = Margin.Dense;

    /// <summary>
    /// Variant applied to input fields unless consumers override it via additional attributes.
    /// </summary>
    [Parameter]
    public Variant ItemVariant { get; set; } = Variant.Outlined;

    /// <summary>
    /// Child content defining search fields; receives the computed attribute dictionary.
    /// </summary>
    [Parameter]
    public RenderFragment<IReadOnlyDictionary<string, object?>>? ChildContent { get; set; }

    /// <summary>
    /// Number of fields shown before the "More" button appears; set to 0 to always show all fields.
    /// </summary>
    [Parameter]
    public int ShowItemsCount { get; set; } = 2;

    /// <summary>
    /// Determines whether the component starts in the fully expanded state when applicable.
    /// </summary>
    [Parameter]
    public bool DefaultExpanded { get; set; }

    /// <summary>
    /// Callback triggered when the user clicks the search button.
    /// </summary>
    [Parameter]
    public EventCallback OnSearch { get; set; }

    /// <summary>
    /// Callback triggered when the user clicks the reset button.
    /// </summary>
    [Parameter]
    public EventCallback OnReset { get; set; }

    // Cached dictionary passed down to child fragments so they inherit the configured defaults.
    private Dictionary<string, object?> _itemAttributes = [];

    private bool _initialized;

    protected override void OnParametersSet()
    {
        if (_initialized) return;

        _itemAttributes = new Dictionary<string, object?>
        {
            { "Margin", ItemMargin },
            { "Variant", ItemVariant }
        };

        _showAll = DefaultExpanded;
        _initialized = true;
    }

    internal void AddItem(QueryFormItem item)
    {
        _items.Add(item);
    }

    private IEnumerable<QueryFormItem> VisibleItems =>
        _showAll || !ShouldShowMoreButton
            ? _items
            : _items.Take(Math.Max(ShowItemsCount, 0));

    private bool ShouldShowMoreButton => ShowItemsCount > 0 && _items.Count > ShowItemsCount;

    private async Task HandleSearchAsync()
    {
        // Ignore duplicate submissions while a search is already in progress.
        if (_loading)
        {
            return;
        }

        _loading = true;
        try
        {
            if (OnSearch.HasDelegate)
            {
                await OnSearch.InvokeAsync();
            }
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task HandleResetAsync()
    {
        if (OnReset.HasDelegate)
        {
            await OnReset.InvokeAsync();
        }
    }

    private void ToggleShowAll()
    {
        // If the total number of items fits within the visible range, skip toggling.
        if (!ShouldShowMoreButton)
        {
            return;
        }

        _showAll = !_showAll;
    }

}
