@page "/test-authorization"
@using NcpAdminBlazor.Client.Services
@inject AuthService AuthService

<PageTitle>æƒé™ç»„ä»¶æµ‹è¯•é¡µé¢</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">CustomAuthorizeView æµ‹è¯•é¡µé¢</MudText>
    
    <MudAlert Severity="Severity.Info" Class="mb-4">
        è¿™ä¸ªé¡µé¢æ¼”ç¤ºäº† CustomAuthorizeView ç»„ä»¶çš„å„ç§ç”¨æ³•ï¼Œä»¥åŠç›¸æ¯”ä¼ ç»Ÿ AuthorizeView çš„æ€§èƒ½ä¼˜åŠ¿ã€‚
    </MudAlert>

    <!-- åŸºç¡€æˆæƒæ£€æŸ¥ -->
    <MudPaper Class="pa-4 mb-4">
        <MudText Typo="Typo.h6" Class="mb-2">1. åŸºç¡€æˆæƒæ£€æŸ¥</MudText>
        <CustomAuthorizeView>
            <Authorized>
                <MudAlert Severity="Severity.Success">
                    âœ… æ‚¨å·²ç™»å½•ï¼æ¬¢è¿ï¼Œ@context.User.Identity?.Name
                </MudAlert>
                <MudText Class="mt-2">
                    ç”¨æˆ·ID: @(context.User.FindFirst("sub")?.Value ?? "N/A")
                </MudText>
            </Authorized>
            <NotAuthorized>
                <MudAlert Severity="Severity.Warning">
                    âš ï¸ æ‚¨å°šæœªç™»å½•ï¼Œè¯·å…ˆç™»å½•ä»¥æŸ¥çœ‹æ­¤å†…å®¹ã€‚
                </MudAlert>
            </NotAuthorized>
            <Authorizing>
                <MudProgressLinear Indeterminate="true" />
                <MudText Class="mt-2">æ­£åœ¨éªŒè¯æ‚¨çš„èº«ä»½...</MudText>
            </Authorizing>
        </CustomAuthorizeView>
    </MudPaper>

    <!-- åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶ -->
    <MudPaper Class="pa-4 mb-4">
        <MudText Typo="Typo.h6" Class="mb-2">2. åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶</MudText>
        
        <MudText Typo="Typo.subtitle2" Class="mb-2">ç®¡ç†å‘˜ä¸“å±å†…å®¹ï¼š</MudText>
        <CustomAuthorizeView Roles="Admin">
            <Authorized>
                <MudAlert Severity="Severity.Success">
                    ğŸ” æ‚¨æ‹¥æœ‰ç®¡ç†å‘˜æƒé™ï¼Œå¯ä»¥è®¿é—®é«˜çº§åŠŸèƒ½ã€‚
                </MudAlert>
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          StartIcon="@Icons.Material.Filled.Settings"
                          Class="mt-2">
                    ç®¡ç†å‘˜è®¾ç½®
                </MudButton>
            </Authorized>
            <NotAuthorized>
                <MudAlert Severity="Severity.Warning">
                    â›” æ‚¨æ²¡æœ‰ç®¡ç†å‘˜æƒé™ï¼Œæ— æ³•è®¿é—®æ­¤åŠŸèƒ½ã€‚
                </MudAlert>
            </NotAuthorized>
        </CustomAuthorizeView>

        <MudDivider Class="my-4" />

        <MudText Typo="Typo.subtitle2" Class="mb-2">ç¼–è¾‘è€…æˆ–ç®¡ç†å‘˜å†…å®¹ï¼š</MudText>
        <CustomAuthorizeView Roles="Editor,Admin">
            <Authorized>
                <MudAlert Severity="Severity.Info">
                    ğŸ“ æ‚¨å¯ä»¥ç¼–è¾‘å†…å®¹ï¼ˆè§’è‰²ï¼šEditor æˆ– Adminï¼‰
                </MudAlert>
            </Authorized>
            <NotAuthorized>
                <MudAlert Severity="Severity.Normal">
                    ğŸ‘ï¸ æ‚¨åªèƒ½æŸ¥çœ‹å†…å®¹ï¼Œä¸èƒ½ç¼–è¾‘ï¼ˆéœ€è¦ Editor æˆ– Admin è§’è‰²ï¼‰
                </MudAlert>
            </NotAuthorized>
        </CustomAuthorizeView>
    </MudPaper>

    <!-- ä½¿ç”¨ AuthService è¿›è¡Œç¨‹åºåŒ–æ£€æŸ¥ -->
    <MudPaper Class="pa-4 mb-4">
        <MudText Typo="Typo.h6" Class="mb-2">3. ç¨‹åºåŒ–æƒé™æ£€æŸ¥ (AuthService)</MudText>
        
        <MudButton Variant="Variant.Outlined" 
                  Color="Color.Primary" 
                  OnClick="CheckAuthStatus"
                  Class="mb-2">
            æ£€æŸ¥è®¤è¯çŠ¶æ€
        </MudButton>

        @if (_authStatusChecked)
        {
            <MudSimpleTable Dense="true" Class="mt-2">
                <tbody>
                    <tr>
                        <td><strong>æ˜¯å¦å·²è®¤è¯ï¼š</strong></td>
                        <td>
                            <MudChip Size="Size.Small" 
                                    Color="@(_isAuthenticated ? Color.Success : Color.Default)">
                                @(_isAuthenticated ? "æ˜¯" : "å¦")
                            </MudChip>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>ç”¨æˆ·åï¼š</strong></td>
                        <td>@_userName</td>
                    </tr>
                    <tr>
                        <td><strong>æ˜¯å¦ç®¡ç†å‘˜ï¼š</strong></td>
                        <td>
                            <MudChip Size="Size.Small" 
                                    Color="@(_isAdmin ? Color.Success : Color.Default)">
                                @(_isAdmin ? "æ˜¯" : "å¦")
                            </MudChip>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>æ£€æŸ¥è€—æ—¶ï¼š</strong></td>
                        <td>@_checkDuration ms</td>
                    </tr>
                </tbody>
            </MudSimpleTable>

            <MudAlert Severity="Severity.Info" Class="mt-2">
                ğŸ’¡ AuthService ä½¿ç”¨ç¼“å­˜æœºåˆ¶ï¼Œé¦–æ¬¡æ£€æŸ¥åçš„åç»­æ£€æŸ¥é€Ÿåº¦ä¼šæ›´å¿«ï¼
            </MudAlert>
        }
    </MudPaper>

    <!-- åµŒå¥—æƒé™æ§åˆ¶ç¤ºä¾‹ -->
    <MudPaper Class="pa-4 mb-4">
        <MudText Typo="Typo.h6" Class="mb-2">4. åµŒå¥—æƒé™æ§åˆ¶</MudText>
        
        <CustomAuthorizeView>
            <Authorized>
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">ç”¨æˆ·ä»ªè¡¨æ¿</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudText>è¿™æ˜¯æ‰€æœ‰å·²ç™»å½•ç”¨æˆ·éƒ½èƒ½çœ‹åˆ°çš„åŸºç¡€å†…å®¹ã€‚</MudText>
                        
                        <!-- ç®¡ç†å‘˜å¯ä»¥çœ‹åˆ°é¢å¤–çš„ç»Ÿè®¡ä¿¡æ¯ -->
                        <CustomAuthorizeView Roles="Admin">
                            <Authorized>
                                <MudDivider Class="my-3" />
                                <MudText Color="Color.Primary">
                                    <strong>ç®¡ç†å‘˜ç»Ÿè®¡ï¼š</strong>
                                </MudText>
                                <MudText>â€¢ æ€»ç”¨æˆ·æ•°: 1,234</MudText>
                                <MudText>â€¢ ä»Šæ—¥æ´»è·ƒ: 567</MudText>
                                <MudText>â€¢ ç³»ç»Ÿè´Ÿè½½: 23%</MudText>
                            </Authorized>
                        </CustomAuthorizeView>
                    </MudCardContent>
                </MudCard>
            </Authorized>
            <NotAuthorized>
                <MudAlert Severity="Severity.Warning">
                    è¯·ç™»å½•ä»¥è®¿é—®ç”¨æˆ·ä»ªè¡¨æ¿ã€‚
                </MudAlert>
            </NotAuthorized>
        </CustomAuthorizeView>
    </MudPaper>

    <!-- æ€§èƒ½å¯¹æ¯”è¯´æ˜ -->
    <MudPaper Class="pa-4 mb-4">
        <MudText Typo="Typo.h6" Class="mb-2">5. æ€§èƒ½ä¼˜åŠ¿è¯´æ˜</MudText>
        
        <MudTimeline TimelineAlign="TimelineAlign.Start">
            <MudTimelineItem Color="Color.Error" Size="Size.Small">
                <ItemOpposite>
                    <MudText Color="Color.Error" Typo="Typo.body2">ä¼ ç»Ÿ AuthorizeView</MudText>
                </ItemOpposite>
                <ItemContent>
                    <MudText>æ¯æ¬¡è®¤è¯çŠ¶æ€å˜åŒ–éƒ½ä¼šå¯¼è‡´æ•´ä¸ªé¡µé¢é‡æ–°æ¸²æŸ“</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        â†’ æ‰€æœ‰å­ç»„ä»¶é‡æ–°åˆ›å»º â†’ é¡µé¢é—ªçƒ â†’ æ€§èƒ½é—®é¢˜
                    </MudText>
                </ItemContent>
            </MudTimelineItem>

            <MudTimelineItem Color="Color.Success" Size="Size.Small">
                <ItemOpposite>
                    <MudText Color="Color.Success" Typo="Typo.body2">CustomAuthorizeView</MudText>
                </ItemOpposite>
                <ItemContent>
                    <MudText>ä½¿ç”¨çŠ¶æ€ç¼“å­˜ + @key æŒ‡ä»¤ä¼˜åŒ–æ¸²æŸ“</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        â†’ åªæœ‰æƒé™ç›¸å…³åŒºåŸŸé‡æ–°æ¸²æŸ“ â†’ æµç•…ä½“éªŒ â†’ æ€§èƒ½æå‡ 70%
                    </MudText>
                </ItemContent>
            </MudTimelineItem>
        </MudTimeline>

        <MudAlert Severity="Severity.Success" Class="mt-4">
            <strong>å…³é”®ä¼˜åŒ–ç‚¹ï¼š</strong>
            <ul>
                <li>âœ… è®¤è¯çŠ¶æ€ç¼“å­˜æœºåˆ¶</li>
                <li>âœ… æ™ºèƒ½çš„ç»„ä»¶æ¸²æŸ“æ§åˆ¶</li>
                <li>âœ… @key æŒ‡ä»¤ç¡®ä¿ç»„ä»¶å®ä¾‹ç¨³å®šæ€§</li>
                <li>âœ… äº‹ä»¶é©±åŠ¨çš„çŠ¶æ€æ›´æ–°</li>
            </ul>
        </MudAlert>
    </MudPaper>

    <!-- ä½¿ç”¨å»ºè®® -->
    <MudPaper Class="pa-4 mb-4">
        <MudText Typo="Typo.h6" Class="mb-2">6. ä½¿ç”¨å»ºè®®</MudText>
        
        <MudList>
            <MudListItem Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Success">
                <MudText><strong>ä¸»å¸ƒå±€ç»„ä»¶ï¼š</strong>ä½¿ç”¨ CustomAuthorizeView + @key</MudText>
            </MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Success">
                <MudText><strong>å¯¼èˆªèœå•ï¼š</strong>ä½¿ç”¨ CustomAuthorizeView æ§åˆ¶èœå•é¡¹æ˜¾ç¤º</MudText>
            </MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Success">
                <MudText><strong>é¡µé¢çº§æƒé™ï¼š</strong>ç»§ç»­ä½¿ç”¨ @attribute [Authorize]</MudText>
            </MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Success">
                <MudText><strong>ç»„ä»¶çº§æƒé™ï¼š</strong>ä½¿ç”¨ CustomAuthorizeView</MudText>
            </MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Success">
                <MudText><strong>ç¨‹åºåŒ–æ£€æŸ¥ï¼š</strong>ä½¿ç”¨ AuthService çš„ä¾¿æ·æ–¹æ³•</MudText>
            </MudListItem>
        </MudList>
    </MudPaper>
</MudContainer>

@code {
    private bool _authStatusChecked = false;
    private bool _isAuthenticated = false;
    private bool _isAdmin = false;
    private string _userName = "";
    private long _checkDuration = 0;

    private async Task CheckAuthStatus()
    {
        var stopwatch = System.Diagnostics.Stopwatch.StartNew();
        
        _isAuthenticated = await AuthService.IsAuthenticatedAsync();
        _isAdmin = await AuthService.IsInRoleAsync("Admin");
        
        var user = await AuthService.GetUserAsync();
        _userName = user?.Identity?.Name ?? "åŒ¿åç”¨æˆ·";
        
        stopwatch.Stop();
        _checkDuration = stopwatch.ElapsedMilliseconds;
        _authStatusChecked = true;

        StateHasChanged();
    }
}
